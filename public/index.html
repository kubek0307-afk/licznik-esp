<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Licznik</title>
<style>
body{background:#111;color:#eee;font-family:Arial;margin:0}
.box{background:#1c1c1c;padding:12px;margin:12px;border-radius:8px}
button,input,textarea,select{width:100%;margin-top:8px;padding:8px}
img{max-width:160px;border-radius:6px;margin-top:6px}
.admin{background:#5b0000}
.tag{font-size:12px;padding:2px 6px;border-radius:4px}
.lysy{background:#2a7}
.pawel{background:#27a}
.poprawa{background:#a72}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <input id="codeInput" type="password" placeholder="Has≈Ço">
  <button onclick="login()">Zaloguj</button>
</div>

<div id="app" style="display:none">

<div class="box">
  Lysy: <b id="cLysy">0</b><br>
  Pawe≈Ç: <b id="cPawel">0</b><br>
  Poprawa: <b id="cPoprawa">0</b><br><br>
  <a href="/map.html">üó∫Ô∏è Mapa</a>
</div>

<div class="box admin" id="adminPanel" style="display:none">
  <b>ADMIN</b>
  <button onclick="resetAll()">‚ö†Ô∏è WYZERUJ WSZYSTKO</button>
</div>

<div class="box">
  <select id="type">
    <option value="lysy">Lysy</option>
    <option value="pawel">Pawe≈Ç</option>
  </select>
  <textarea id="text" placeholder="Opis"></textarea>
  <input type="file" id="img">
  <button onclick="send()">Dodaj</button>
</div>

<div class="box">
  <h3>Historia</h3>
  <div id="historyDiv"></div>
</div>

</div>

<script>
let accessCode="", isAdmin=false;

function login(){
  accessCode = codeInput.value;
  localStorage.setItem("accessCode", accessCode);
  loadData();
}

async function loadData(){
  const res = await fetch("/api/data",{ headers:{ "access-code": accessCode }});
  if(!res.ok){ alert("Z≈Çe has≈Ço"); return; }

  const d = await res.json();
  isAdmin = d.isAdmin;

  loginBox.style.display="none";
  app.style.display="block";
  adminPanel.style.display = isAdmin ? "block" : "none";

  cLysy.innerText = d.counter.lysy;
  cPawel.innerText = d.counter.pawel;
  cPoprawa.innerText = d.counter.poprawa;

  historyDiv.innerHTML="";
  d.history.forEach(h=>{
    const el=document.createElement("div");
    el.className="box";
    el.innerHTML=`
      <span class="tag ${h.type}">${h.type}</span> ${h.date}<br>
      ${h.text||""}
      ${h.img?`<img src="${h.img}">`:""}
      ${isAdmin && h.type!=="poprawa" ? `
        <br><button onclick="poprawa('${h._id}')">üîÑ Poprawa</button>
      `:""}
    `;
    historyDiv.appendChild(el);
  });
}

function send(){
  const fd=new FormData();
  fd.append("type",type.value);
  fd.append("text",text.value);
  if(img.files[0]) fd.append("image",img.files[0]);

  navigator.geolocation.getCurrentPosition(
    p=>{ fd.append("lat",p.coords.latitude); fd.append("lng",p.coords.longitude); sendForm(fd); },
    ()=>sendForm(fd)
  );
}

function sendForm(fd){
  fetch("/api/add",{ method:"POST", headers:{ "access-code": accessCode }, body:fd })
    .then(loadData);
}

function poprawa(id){
  fetch("/api/poprawa/"+id,{ method:"POST", headers:{ "access-code": accessCode }})
    .then(loadData);
}

function resetAll(){
  if(confirm("WYZEROWAƒÜ WSZYSTKO?"))
    fetch("/api/reset",{ method:"POST", headers:{ "access-code": accessCode }})
      .then(loadData);
}

if(localStorage.getItem("accessCode")){
  accessCode = localStorage.getItem("accessCode");
  loadData();
}
</script>

</body>
</html>
