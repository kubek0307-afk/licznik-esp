<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Licznik</title>
<style>
body{background:#111;color:#eee;font-family:Arial;margin:0}
.box{background:#1c1c1c;padding:12px;margin:12px;border-radius:8px}
button{width:100%;padding:12px;margin-top:8px}
img{max-width:100%;border-radius:6px}
a{color:#4fa3ff}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <input id="codeInput" type="password" placeholder="Kod dostƒôpu">
  <button onclick="login()">Zaloguj</button>
</div>

<div id="app" style="display:none">

<div class="box">
  Lysy: <b id="cLysy">0</b><br>
  Pawe≈Ç: <b id="cPawel">0</b><br><br>
  <a href="/map.html">üó∫Ô∏è Zobacz mapƒô</a>
</div>

<div class="box">
  <select id="person">
    <option value="lysy">Lysy</option>
    <option value="pawel">Pawe≈Ç</option>
  </select>
  <textarea id="text" placeholder="Opis"></textarea>
  <input type="file" id="img">
  <button onclick="send()">Dodaj</button>
</div>

<div class="box">
  <h3>Historia</h3>
  <div id="history"></div>
</div>

</div>

<script>
let accessCode = localStorage.getItem("accessCode") || "";

function login(){
  accessCode = codeInput.value;
  localStorage.setItem("accessCode", accessCode);
  loadData();
}

function showApp(){
  loginBox.style.display="none";
  app.style.display="block";
}

async function loadData(){
  const r = await fetch("/api/data",{headers:{"access-code":accessCode}});
  if(!r.ok){alert("Z≈Çy kod");return;}
  const d = await r.json();
  showApp();
  cLysy.innerText=d.lysy;
  cPawel.innerText=d.pawel;

  history.innerHTML="";
  d.history.forEach(h=>{
    history.innerHTML+=`
      <div class="box">
        <b>${h.person}</b> | ${h.date}<br>
        ${h.text||""}
        ${h.img?`<br><img src="${h.img}">`:""}
        ${h.location?`<br><a target="_blank" href="https://maps.google.com?q=${h.location.lat},${h.location.lng}">üìç mapa</a>`:""}
      </div>`;
  });
}

function send(){
  const fd=new FormData();
  fd.append("person",person.value);
  fd.append("text",text.value);
  if(img.files[0]) fd.append("image",img.files[0]);

  navigator.geolocation.getCurrentPosition(
    p=>{
      fd.append("lat",p.coords.latitude);
      fd.append("lng",p.coords.longitude);
      sendForm(fd);
    },
    ()=>sendForm(fd)
  );
}

async function sendForm(fd){
  await fetch("/api/add",{method:"POST",headers:{"access-code":accessCode},body:fd});
  text.value="";img.value="";
  loadData();
}

if(accessCode) loadData();
</script>
</body>
</html>
