<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Licznik</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#111;color:#eee;font-family:Arial;margin:0}
.box{background:#1c1c1c;padding:12px;margin:12px;border-radius:8px}
button,input,textarea,select{width:100%;margin-top:8px;padding:8px}

#posts{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
}

.card{
  position:relative;
  height:220px;
  background-size:cover;
  background-position:center;
  border-radius:8px;
  overflow:hidden;
  cursor:pointer;
}

.card::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.55);
}

.card-content{
  position:absolute;
  bottom:0;
  padding:10px;
  z-index:2;
}

.tag{font-size:12px;padding:2px 6px;border-radius:4px}
.lysy{background:#2a7}
.pawel{background:#27a}
.poprawa{background:#a72}

.adminBtn{
  margin-top:6px;
  background:#a33;
  border:none;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="box" id="loginBox">
  <input id="codeInput" type="password" placeholder="HasÅ‚o">
  <button onclick="login()">Zaloguj</button>
</div>

<div id="app" style="display:none">

<div class="box" id="counterBox">
  Lysy: <b id="cLysy">0</b><br>
  PaweÅ‚: <b id="cPawel">0</b><br>
  Poprawa: <b id="cPoprawa">0</b>
</div>

<div class="box">
  <select id="type">
    <option value="lysy">Lysy</option>
    <option value="pawel">PaweÅ‚</option>
    <option value="poprawa">Poprawa</option>
  </select>

  <input id="title" placeholder="TytuÅ‚">
  <textarea id="text" placeholder="Opis"></textarea>

  <label>ZdjÄ™cie tÅ‚a</label>
  <input type="file" id="img" accept="image/*">

  <label>Galeria</label>
  <input type="file" id="gallery" multiple accept="image/*">

  <button onclick="send()">Dodaj</button>
</div>

<div class="box">
  <h3>Posty</h3>
  <div id="posts"></div>
</div>

</div>

<script>
let accessCode="";
let isAdmin=false;

function login(){
  accessCode = codeInput.value;
  localStorage.setItem("accessCode", accessCode);
  load();
}

async function load(){
  const r = await fetch("/api/data",{ headers:{ "access-code": accessCode }});
  if(!r.ok){ alert("ZÅ‚e hasÅ‚o"); return; }
  const d = await r.json();
  isAdmin = d.isAdmin;

  loginBox.style.display="none";
  app.style.display="block";

  cLysy.innerText = d.counter.lysy;
  cPawel.innerText = d.counter.pawel;
  cPoprawa.innerText = d.counter.poprawa;

  if(isAdmin && !document.getElementById("resetBtn")){
    const btn=document.createElement("button");
    btn.id="resetBtn";
    btn.innerText="ðŸ”„ Reset licznikÃ³w";
    btn.onclick=resetCounters;
    btn.style.background="#444";
    btn.style.marginTop="8px";
    counterBox.appendChild(btn);
  }

  posts.innerHTML="";
  d.history.forEach(p=>{
    const el=document.createElement("div");
    el.className="card";
    el.style.backgroundImage = p.image ? `url('${p.image}')` : "none";
    el.onclick=()=>location.href=`/post.html?id=${p._id}`;

    el.innerHTML=`
      <div class="card-content">
        <span class="tag ${p.type}">${p.type}</span>
        <h4>${p.title || ""}</h4>
        <small>${p.date}</small>

        ${isAdmin ? `
          <button class="adminBtn"
            onclick="del('${p._id}', event)">ðŸ—‘ UsuÅ„</button>
        ` : ""}
      </div>
    `;
    posts.appendChild(el);
  });
}

function send(){
  const fd=new FormData();
  fd.append("type", type.value);
  fd.append("title", title.value);
  fd.append("text", text.value);

  if (img.files[0]) fd.append("image", img.files[0]);
  [...gallery.files].forEach(f=>fd.append("gallery",f));

  fetch("/api/add",{ method:"POST", headers:{ "access-code": accessCode }, body:fd })
    .then(load);
}

function del(id,e){
  e.stopPropagation();
  if(!confirm("UsunÄ…Ä‡ post?")) return;
  fetch("/api/post/"+id,{
    method:"DELETE",
    headers:{ "access-code": accessCode }
  }).then(load);
}

function resetCounters(){
  if(!confirm("WyzerowaÄ‡ wszystkie liczniki?")) return;
  fetch("/api/reset",{
    method:"POST",
    headers:{ "access-code": accessCode }
  }).then(load);
}

if(localStorage.getItem("accessCode")){
  accessCode = localStorage.getItem("accessCode");
  load();
}
</script>

</body>
</html>
